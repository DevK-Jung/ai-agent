<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Router Workflow Architecture</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #04080f;
    --grid: rgba(0,180,255,0.04);
    --surface: rgba(5,20,40,0.9);
    --border: rgba(0,180,255,0.15);
    --accent: #00b4ff;
    --accent2: #00ffcc;
    --warn: #ffd166;
    --purple: #a78bfa;
    --red: #f87171;
    --teal: #2dd4bf;
    --green: #4ade80;
    --text: #c8dff0;
    --muted: #3d6080;
    --node-bg: rgba(0,30,60,0.95);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scan 4s ease-in-out infinite;
    z-index: 1;
    opacity: 0.4;
  }

  @keyframes scan {
    0% { top: 0; opacity: 0; }
    10% { opacity: 0.4; }
    90% { opacity: 0.4; }
    100% { top: 100vh; opacity: 0; }
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
    position: relative;
    z-index: 2;
  }

  .header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 28px;
    animation: fadeDown 0.6s ease both;
  }

  .sys-label { font-size: 10px; color: var(--muted); letter-spacing: 3px; margin-bottom: 8px; }
  h1 { font-family: 'Rajdhani', sans-serif; font-size: 30px; font-weight: 700; color: #fff; line-height: 1.1; }
  h1 span { color: var(--accent); }
  .subtitle { font-size: 11px; color: var(--muted); margin-top: 6px; letter-spacing: 1px; }
  .header-right { text-align: right; font-size: 10px; color: var(--muted); line-height: 2.2; }

  .badge {
    display: inline-block; padding: 2px 8px;
    border: 1px solid var(--accent2); color: var(--accent2);
    font-size: 9px; letter-spacing: 2px; border-radius: 2px;
  }

  .main-grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 14px;
    margin-bottom: 14px;
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.5;
  }

  .panel-label { font-size: 9px; color: var(--muted); letter-spacing: 3px; padding: 12px 16px 0; }
  .graph-panel { padding: 16px; }
  svg { width: 100%; overflow: visible; }

  @keyframes dash { to { stroke-dashoffset: -20; } }
  .flow-line { animation: dash 1.5s linear infinite; }

  .code-panel { display: flex; flex-direction: column; }

  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
    flex-wrap: wrap;
  }
  .tab-bar::-webkit-scrollbar { display: none; }

  .tab {
    padding: 9px 12px;
    font-size: 8.5px; letter-spacing: 1px;
    color: var(--muted); cursor: pointer; white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    font-family: 'Share Tech Mono', monospace;
    background: none; border-top: none; border-left: none; border-right: none;
  }
  .tab:hover { color: var(--accent); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .code-content {
    padding: 14px 16px;
    font-size: 10.5px; line-height: 1.8; color: #7dd3fc;
    flex: 1; overflow-x: auto;
    background: rgba(0,5,15,0.6);
    white-space: pre; display: none; min-height: 380px;
  }
  .code-content.active { display: block; }

  .kw { color: #c084fc; }
  .fn { color: #67e8f9; }
  .st { color: #86efac; }
  .cm { color: #4b5563; }
  .nm { color: #fbbf24; }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px; margin-bottom: 14px;
    animation: fadeUp 0.8s ease 0.4s both;
  }

  .info-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; padding: 14px; position: relative; overflow: hidden;
  }
  .info-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; }
  .info-card.c1::after { background: var(--accent); }
  .info-card.c2::after { background: var(--teal); }
  .info-card.c3::after { background: var(--warn); }
  .info-card.c4::after { background: var(--purple); }

  .card-icon { font-size: 18px; margin-bottom: 6px; }
  .card-title { font-size: 10px; color: #fff; font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
  .card-desc { font-size: 9.5px; color: var(--muted); line-height: 1.6; }

  .token-section {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 4px; padding: 14px 16px; margin-bottom: 14px;
    animation: fadeUp 0.8s ease 0.1s both;
  }

  .meter-track {
    height: 7px; background: rgba(0,180,255,0.06);
    border: 1px solid var(--border); border-radius: 2px;
    margin: 10px 0 6px; position: relative;
  }
  .meter-fill { height: 100%; border-radius: 2px; animation: fillUp 1.5s ease 0.5s both; }
  @keyframes fillUp { from { width: 0 !important; } }
  .meter-line {
    position: absolute; top: -4px; bottom: -4px;
    width: 1px; background: var(--warn); transform: translateX(-50%);
  }
  .meter-threshold {
    position: absolute; top: -22px; transform: translateX(-50%);
    font-size: 9px; color: var(--warn); white-space: nowrap;
  }
  .meter-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--muted); }

  .footer {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 9px; color: var(--muted); letter-spacing: 2px;
    padding-top: 14px; border-top: 1px solid var(--border);
  }
  .status-dot {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent2); margin-right: 6px;
    animation: pulse 2s ease infinite;
  }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .graph-panel, .code-panel { animation: fadeUp 0.7s ease 0.1s both; }

  @media (max-width: 860px) {
    .main-grid { grid-template-columns: 1fr; }
    .info-grid { grid-template-columns: repeat(2, 1fr); }
    h1 { font-size: 22px; }
  }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div>
      <div class="sys-label">// SYSTEM ARCHITECTURE v4.0 â€” ROUTER WORKFLOW</div>
      <h1>Router <span>Ã—</span> Multi-Agent</h1>
      <div class="subtitle">token_router edge â†’ summarize_node (tiktoken) â†’ detect_agent â†’ chat / meeting sub-agent</div>
    </div>
    <div class="header-right">
      <div><span class="badge">PRODUCTION</span></div>
      <div style="margin-top:6px">Model: gpt-4o Â· 128K ctx</div>
      <div>Token check: tiktoken (local)</div>
      <div>Threshold: 70% Â· 89,600 tk</div>
    </div>
  </div>

  <!-- Token Meter -->
  <div class="token-section">
    <div class="panel-label">// TOKEN BUDGET â€” token_router edge íŒë‹¨ ê¸°ì¤€</div>
    <div style="margin-top:10px">
      <div class="meter-track">
        <div class="meter-fill" style="width:55%;background:linear-gradient(90deg,#00b4ff,#00e5ff)"></div>
        <div class="meter-line" style="left:70%">
          <div class="meter-threshold">TRIGGER Â· 89,600 tk</div>
        </div>
      </div>
      <div class="meter-labels">
        <span>0</span>
        <span style="color:var(--accent)">ë¯¸ì´ˆê³¼ â†’ "skip" â†’ detect_agent ì§í–‰</span>
        <span style="color:var(--warn)">ì´ˆê³¼ â†’ "summarize" â†’ summarize_node â†’ detect_agent</span>
        <span>128K</span>
      </div>
    </div>
  </div>

  <div class="main-grid">

    <!-- Graph -->
    <div class="panel graph-panel">
      <div class="panel-label">// GRAPH ARCHITECTURE</div>
      <svg viewBox="0 0 740 660" style="margin-top:10px">
        <defs>
          <marker id="ab" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#00b4ff"/></marker>
          <marker id="ag" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#00ffcc"/></marker>
          <marker id="aw" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#ffd166"/></marker>
          <marker id="ap" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#a78bfa"/></marker>
          <marker id="at" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#2dd4bf"/></marker>
          <marker id="ar" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#f87171"/></marker>
          <marker id="agreen" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#4ade80"/></marker>
          <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>

        <!-- checkpointer bracket -->
        <rect x="8" y="8" width="724" height="640" rx="4"
          fill="none" stroke="rgba(0,180,255,0.05)" stroke-width="1" stroke-dasharray="4,4"/>
        <text x="14" y="22" fill="rgba(0,180,255,0.2)" font-size="8" font-family="'Share Tech Mono'" letter-spacing="2">CHECKPOINTED STATE (PostgreSQL Â· thread_id)</text>

        <!-- START -->
        <g filter="url(#glow)">
          <rect x="290" y="30" width="120" height="32" rx="16" fill="rgba(0,255,204,0.08)" stroke="#00ffcc" stroke-width="1.5"/>
          <text x="350" y="51" text-anchor="middle" fill="#00ffcc" font-size="12" font-family="'Rajdhani'" font-weight="700" letter-spacing="2">â–¶ START</text>
        </g>

        <!-- START â†’ token_router -->
        <line x1="350" y1="62" x2="350" y2="95" stroke="#00b4ff" stroke-width="1.5" marker-end="url(#ab)" class="flow-line" stroke-dasharray="5,3"/>

        <!-- token_router diamond (edge) -->
        <g filter="url(#glow)">
          <polygon points="350,96 420,126 350,156 280,126" fill="rgba(255,209,102,0.06)" stroke="#ffd166" stroke-width="1.5"/>
          <text x="350" y="121" text-anchor="middle" fill="#ffd166" font-size="9" font-family="'Share Tech Mono'">token_router</text>
          <text x="350" y="135" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">edge Â· tiktoken</text>
        </g>

        <!-- "summarize" branch (left) -->
        <line x1="280" y1="126" x2="175" y2="126" stroke="#ffd166" stroke-width="1.5" marker-end="url(#aw)" class="flow-line" stroke-dasharray="5,3"/>
        <text x="214" y="119" fill="#ffd166" font-size="8.5" font-family="'Share Tech Mono'">"summarize"</text>

        <!-- summarize_node -->
        <g>
          <rect x="32" y="96" width="145" height="72" rx="4" fill="rgba(20,10,0,0.98)" stroke="#ffd166" stroke-width="1.5"/>
          <rect x="32" y="96" width="5" height="72" rx="2" fill="#ffd166"/>
          <text x="113" y="122" text-anchor="middle" fill="#ffd166" font-size="12" font-family="'Rajdhani'" font-weight="700" letter-spacing="1">summarize_node</text>
          <text x="113" y="139" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="'Share Tech Mono'">ìš”ì•½ ìƒì„± (gpt-4o-mini)</text>
          <text x="113" y="153" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">RemoveMessage Â· SystemMsg ì‚½ì…</text>
        </g>

        <!-- summarize_node â†’ detect_agent -->
        <path d="M104,168 Q104,210 270,230" stroke="#ffd166" stroke-width="1.5" fill="none" marker-end="url(#aw)" class="flow-line" stroke-dasharray="5,3"/>

        <!-- "skip" branch (right/center) -->
        <line x1="350" y1="156" x2="350" y2="208" stroke="#00ffcc" stroke-width="1.5" marker-end="url(#ag)" class="flow-line" stroke-dasharray="5,3"/>
        <text x="358" y="186" fill="#00ffcc" font-size="8.5" font-family="'Share Tech Mono'">"skip"</text>

        <!-- detect_agent -->
        <g filter="url(#glow)">
          <rect x="220" y="210" width="260" height="70" rx="4" fill="rgba(0,20,60,0.98)" stroke="#00b4ff" stroke-width="2"/>
          <rect x="220" y="210" width="5" height="70" rx="2" fill="#00b4ff"/>
          <rect x="434" y="214" width="40" height="13" rx="2" fill="rgba(0,180,255,0.12)" stroke="rgba(0,180,255,0.3)" stroke-width="1"/>
          <text x="454" y="224" text-anchor="middle" fill="#00b4ff" font-size="7.5" font-family="'Share Tech Mono'">LLM</text>
          <text x="354" y="242" text-anchor="middle" fill="#00b4ff" font-size="13" font-family="'Rajdhani'" font-weight="700" letter-spacing="1">detect_agent</text>
          <text x="354" y="259" text-anchor="middle" fill="#7dd3fc" font-size="8.5" font-family="'Share Tech Mono'">gpt-4o-mini ì¸í…íŠ¸ ê°ì§€</text>
          <text x="354" y="273" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">agent_type ëª…ì‹œ ì‹œ LLM í˜¸ì¶œ ìŠ¤í‚µ</text>
        </g>

        <!-- detect_agent â†’ select_agent -->
        <line x1="350" y1="280" x2="350" y2="316" stroke="#00b4ff" stroke-width="1.5" marker-end="url(#ab)" class="flow-line" stroke-dasharray="5,3"/>

        <!-- select_agent diamond (edge) -->
        <g>
          <polygon points="350,318 430,346 350,374 270,346" fill="rgba(0,180,255,0.05)" stroke="rgba(0,180,255,0.4)" stroke-width="1.5"/>
          <text x="350" y="341" text-anchor="middle" fill="#7dd3fc" font-size="9" font-family="'Share Tech Mono'">select_agent</text>
          <text x="350" y="355" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">edge Â· agent_type</text>
        </g>

        <!-- select_agent â†’ chat_agent -->
        <line x1="270" y1="346" x2="170" y2="346" stroke="#00ffcc" stroke-width="1.5" marker-end="url(#ag)" class="flow-line" stroke-dasharray="5,3"/>
        <text x="196" y="339" fill="#00ffcc" font-size="8" font-family="'Share Tech Mono'">"chat"</text>

        <!-- select_agent â†’ meeting_agent -->
        <line x1="430" y1="346" x2="530" y2="346" stroke="#a78bfa" stroke-width="1.5" marker-end="url(#ap)" class="flow-line" stroke-dasharray="5,3"/>
        <text x="448" y="339" fill="#a78bfa" font-size="8" font-family="'Share Tech Mono'">"meeting"</text>

        <!-- chat_agent subgraph -->
        <g>
          <rect x="28" y="370" width="145" height="150" rx="4" fill="rgba(0,15,40,0.95)" stroke="#00ffcc" stroke-width="1.5" stroke-dasharray="6,3"/>
          <text x="100" y="390" text-anchor="middle" fill="#00ffcc" font-size="8" font-family="'Share Tech Mono'" letter-spacing="2">CHAT AGENT</text>
          <!-- classifier -->
          <rect x="38" y="398" width="125" height="42" rx="3" fill="rgba(0,30,60,0.9)" stroke="rgba(0,180,255,0.4)" stroke-width="1"/>
          <text x="100" y="416" text-anchor="middle" fill="#7dd3fc" font-size="9" font-family="'Rajdhani'" font-weight="700">classifier</text>
          <text x="100" y="430" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">gpt-4o-mini Â· FACT/SUMMARY</text>
          <!-- arrow -->
          <line x1="100" y1="440" x2="100" y2="453" stroke="#00b4ff" stroke-width="1" marker-end="url(#ab)"/>
          <!-- generator -->
          <rect x="38" y="455" width="125" height="52" rx="3" fill="rgba(0,30,60,0.9)" stroke="rgba(0,255,204,0.4)" stroke-width="1"/>
          <text x="100" y="474" text-anchor="middle" fill="#00ffcc" font-size="9" font-family="'Rajdhani'" font-weight="700">generator</text>
          <text x="100" y="489" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">gpt-4o Â· RAG context</text>
          <text x="100" y="501" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">SSE streaming</text>
        </g>

        <!-- meeting_agent subgraph -->
        <g>
          <rect x="530" y="370" width="175" height="168" rx="4" fill="rgba(20,0,40,0.95)" stroke="#a78bfa" stroke-width="1.5" stroke-dasharray="6,3"/>
          <text x="617" y="390" text-anchor="middle" fill="#a78bfa" font-size="8" font-family="'Share Tech Mono'" letter-spacing="2">MEETING AGENT</text>
          <!-- transcribe -->
          <rect x="540" y="398" width="155" height="36" rx="3" fill="rgba(30,0,60,0.9)" stroke="rgba(167,139,250,0.4)" stroke-width="1"/>
          <text x="617" y="413" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="'Rajdhani'" font-weight="700">transcribe_audio</text>
          <text x="617" y="426" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">WhisperX STT + í™”ìë¶„ë¦¬</text>
          <!-- arrow -->
          <line x1="617" y1="434" x2="617" y2="447" stroke="#a78bfa" stroke-width="1" marker-end="url(#ap)"/>
          <!-- merge -->
          <rect x="540" y="449" width="155" height="34" rx="3" fill="rgba(30,0,60,0.9)" stroke="rgba(167,139,250,0.4)" stroke-width="1"/>
          <text x="617" y="464" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="'Rajdhani'" font-weight="700">merge_transcript</text>
          <text x="617" y="477" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">í™”ìë³„ ë°œì–¸ ê·¸ë£¹í™”</text>
          <!-- arrow -->
          <line x1="617" y1="483" x2="617" y2="496" stroke="#a78bfa" stroke-width="1" marker-end="url(#ap)"/>
          <!-- generate -->
          <rect x="540" y="498" width="155" height="28" rx="3" fill="rgba(30,0,60,0.9)" stroke="rgba(167,139,250,0.4)" stroke-width="1"/>
          <text x="617" y="513" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="'Rajdhani'" font-weight="700">generate_minutes</text>
          <text x="617" y="526" text-anchor="middle" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">gpt-4o íšŒì˜ë¡ ìƒì„±</text>
        </g>

        <!-- chat_agent â†’ END -->
        <line x1="100" y1="520" x2="100" y2="560" stroke="#f87171" stroke-width="1.5" marker-end="url(#ar)" class="flow-line" stroke-dasharray="5,3"/>
        <path d="M100,560 Q100,590 310,612" stroke="#f87171" stroke-width="1.5" fill="none" marker-end="url(#ar)" class="flow-line" stroke-dasharray="5,3"/>

        <!-- meeting_agent â†’ END -->
        <line x1="617" y1="538" x2="617" y2="560" stroke="#f87171" stroke-width="1.5" marker-end="url(#ar)" class="flow-line" stroke-dasharray="5,3"/>
        <path d="M617,560 Q617,590 420,612" stroke="#f87171" stroke-width="1.5" fill="none" marker-end="url(#ar)" class="flow-line" stroke-dasharray="5,3"/>

        <!-- END -->
        <g>
          <rect x="300" y="613" width="100" height="30" rx="15" fill="rgba(248,113,113,0.08)" stroke="#f87171" stroke-width="1.5"/>
          <text x="350" y="633" text-anchor="middle" fill="#f87171" font-size="12" font-family="'Rajdhani'" font-weight="700" letter-spacing="2">â–  END</text>
        </g>

        <!-- State fields box -->
        <g>
          <rect x="530" y="210" width="190" height="130" rx="4" fill="rgba(0,8,20,0.92)" stroke="rgba(0,180,255,0.18)" stroke-width="1"/>
          <text x="540" y="228" fill="rgba(0,180,255,0.4)" font-size="8" font-family="'Share Tech Mono'" letter-spacing="2">ROUTERSTATE FIELDS</text>
          <text x="540" y="246" fill="#4a9ebb" font-size="8.5" font-family="'Share Tech Mono'">messages: list          â† MessagesState</text>
          <text x="540" y="262" fill="#4a9ebb" font-size="8.5" font-family="'Share Tech Mono'">agent_type: str         â† "chat" | "meeting"</text>
          <text x="540" y="278" fill="#4a9ebb" font-size="8.5" font-family="'Share Tech Mono'">audio_file_path: str    â† meeting ì „ë‹¬ìš©</text>
          <text x="540" y="294" fill="#4a9ebb" font-size="8.5" font-family="'Share Tech Mono'">answer: str</text>
          <text x="540" y="310" fill="#4a9ebb" font-size="8.5" font-family="'Share Tech Mono'">question_type: str      â† FACT/SUMMARY/...</text>
          <text x="540" y="326" fill="var(--muted)" font-size="7.5" font-family="'Share Tech Mono'">session_id Â· user_id Â· rag_context</text>
        </g>

      </svg>
    </div>

    <!-- Code Panel -->
    <div class="panel code-panel">
      <div class="panel-label">// IMPLEMENTATION</div>
      <div class="tab-bar">
        <button class="tab active" onclick="showTab('state',this)">STATE</button>
        <button class="tab" onclick="showTab('token',this)">TOKEN_ROUTER</button>
        <button class="tab" onclick="showTab('summ',this)">SUMMARIZE</button>
        <button class="tab" onclick="showTab('graph',this)">GRAPH</button>
      </div>

      <div id="tab-state" class="code-content active"><span class="kw">from</span> langgraph.graph <span class="kw">import</span> MessagesState
<span class="kw">from</span> typing <span class="kw">import</span> Optional

<span class="cm"># LangMem ì™„ì „ ì œê±° - ìˆœìˆ˜ MessagesState ê¸°ë°˜</span>
<span class="kw">class</span> <span class="fn">RouterState</span>(MessagesState):
    user_id: Optional[<span class="nm">str</span>]
    session_id: Optional[<span class="nm">str</span>]
    agent_type: Optional[<span class="nm">str</span>]  <span class="cm"># "chat" | "meeting"</span>
    answer: Optional[<span class="nm">str</span>]
    model_used: <span class="nm">str</span>
    question_type: Optional[<span class="nm">str</span>]
    rag_context: Optional[<span class="nm">str</span>]

    <span class="cm"># Meeting Agent ì˜¤ë””ì˜¤ ê²½ë¡œ ì „ë‹¬ìš©</span>
    audio_file_path: Optional[<span class="nm">str</span>]

<span class="cm"># ì´ì „ ëŒ€ë¹„ ì œê±°ëœ í•„ë“œ:</span>
<span class="cm">#   summary: RunningSummary  â†’ ì‚­ì œ</span>
<span class="cm">#   context: Dict[str,Any]  â†’ ì‚­ì œ</span>
<span class="cm">#   summarized_messages: list â†’ ì‚­ì œ</span>
<span class="cm">#</span>
<span class="cm"># messages ìì²´ë¥¼ êµì²´í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½:</span>
<span class="cm"># [SystemMessage(ìš”ì•½), *ìµœê·¼ë©”ì‹œì§€] í˜•íƒœë¡œ</span>
<span class="cm"># RemoveMessage + SystemMessageë¥¼ í•œ ë…¸ë“œì—ì„œ ë°˜í™˜</span></div>

      <div id="tab-token" class="code-content"><span class="cm"># edges/router/token_router.py</span>
<span class="cm"># STARTì—ì„œ ì¡°ê±´ë¶€ ë¶„ê¸° - ë§¤ í„´ í† í° ì²´í¬</span>
<span class="kw">from</span> typing <span class="kw">import</span> Literal
<span class="kw">from</span> app.agents.core.llm_provider <span class="kw">import</span> gpt4o
<span class="kw">from</span> app.core.config <span class="kw">import</span> settings

<span class="kw">def</span> <span class="fn">route_check_token</span>(
    state: RouterState
) -> Literal[<span class="st">"summarize"</span>, <span class="st">"skip"</span>]:
    messages = state.<span class="fn">get</span>(<span class="st">"messages"</span>, [])

    <span class="cm"># LangChain ë‚´ë¶€ì ìœ¼ë¡œ tiktoken ì‚¬ìš©</span>
    <span class="cm"># API í˜¸ì¶œ ì—†ìŒ - ìˆœìˆ˜ ë¡œì»¬ ê³„ì‚°</span>
    token_count = gpt4o.<span class="fn">get_num_tokens_from_messages</span>(
        messages
    )

    <span class="kw">return</span> (
        <span class="st">"summarize"</span>
        <span class="kw">if</span> token_count > settings.SUMMARIZE_MAX_TOKENS
        <span class="kw">else</span> <span class="st">"skip"</span>
    )

<span class="cm"># workflowì—ì„œ:</span>
<span class="cm"># workflow.add_conditional_edges(</span>
<span class="cm">#     START,</span>
<span class="cm">#     route_check_token,</span>
<span class="cm">#     {"summarize": ..., "skip": DETECT_AGENT}</span>
<span class="cm"># )</span></div>

      <div id="tab-summ" class="code-content"><span class="cm"># nodes/router/summarize.py</span>
<span class="cm"># í† í° ì´ˆê³¼ ì‹œì—ë§Œ í˜¸ì¶œë¨ (token_routerê°€ íŒë‹¨)</span>
<span class="kw">from</span> langchain_core.messages <span class="kw">import</span> (
    RemoveMessage, SystemMessage
)
<span class="kw">from</span> app.agents.prompts.router <span class="kw">import</span> SUMMARIZE_PROMPT

_summarize_chain = (
    SUMMARIZE_PROMPT
    | gpt4o_mini.<span class="fn">bind</span>(max_tokens=<span class="nm">512</span>)
)

<span class="kw">async def</span> <span class="fn">summarize_node</span>(state):
    messages = state[<span class="st">"messages"</span>]

    <span class="cm"># í† í° ì˜ˆì‚° 30% ë‚´ì—ì„œ ìµœê·¼ ë©”ì‹œì§€ ìµœëŒ€ ë³´ì¡´</span>
    budget = <span class="nm">int</span>(settings.SUMMARIZE_MAX_TOKENS * <span class="nm">0.3</span>)
    kept, used = [], <span class="nm">0</span>
    <span class="kw">for</span> m <span class="kw">in</span> <span class="fn">reversed</span>(messages):
        t = gpt4o.<span class="fn">get_num_tokens_from_messages</span>([m])
        <span class="kw">if</span> used + t <= budget:
            kept.<span class="fn">insert</span>(<span class="nm">0</span>, m); used += t
        <span class="kw">else</span>: <span class="kw">break</span>

    to_summarize = [
        m <span class="kw">for</span> m <span class="kw">in</span> messages
        <span class="kw">if</span> <span class="fn">id</span>(m) <span class="kw">not in</span> {<span class="fn">id</span>(k) <span class="kw">for</span> k <span class="kw">in</span> kept}
    ]
    res = <span class="kw">await</span> _summarize_chain.<span class="fn">ainvoke</span>(
        {<span class="st">"messages"</span>: to_summarize}
    )
    <span class="cm"># messages ìì²´ë¥¼ êµì²´ (ë³„ë„ í‚¤ ë¶ˆí•„ìš”)</span>
    <span class="kw">return</span> {<span class="st">"messages"</span>: [
        *[<span class="fn">RemoveMessage</span>(id=m.id) <span class="kw">for</span> m <span class="kw">in</span> to_summarize],
        <span class="fn">SystemMessage</span>(<span class="st">f"[ì´ì „ ëŒ€í™” ìš”ì•½]\n</span>{res.content}<span class="st">"</span>),
        *kept,
    ]}</div>

      <div id="tab-graph" class="code-content"><span class="kw">from</span> langgraph.graph <span class="kw">import</span> StateGraph, START, END

workflow = <span class="fn">StateGraph</span>(RouterState)

<span class="cm"># --- ë…¸ë“œ ë“±ë¡ ---</span>
workflow.<span class="fn">add_node</span>(<span class="st">"summarize_conversations"</span>, summarize_node)
workflow.<span class="fn">add_node</span>(<span class="st">"detect_agent"</span>, detect_agent)
workflow.<span class="fn">add_node</span>(<span class="st">"chat_agent"</span>, <span class="fn">create_chat_subgraph</span>())
workflow.<span class="fn">add_node</span>(<span class="st">"meeting_agent"</span>, <span class="fn">create_meeting_subgraph</span>())

<span class="cm"># --- ì—£ì§€ ì—°ê²° ---</span>

<span class="cm"># START â†’ token_router â†’ summarize or skip</span>
workflow.<span class="fn">add_conditional_edges</span>(
    START, route_check_token,
    {
        <span class="st">"summarize"</span>: <span class="st">"summarize_conversations"</span>,
        <span class="st">"skip"</span>:      <span class="st">"detect_agent"</span>,
    }
)
workflow.<span class="fn">add_edge</span>(
    <span class="st">"summarize_conversations"</span>, <span class="st">"detect_agent"</span>
)

<span class="cm"># detect_agent â†’ select_agent â†’ sub-agent</span>
workflow.<span class="fn">add_conditional_edges</span>(
    <span class="st">"detect_agent"</span>, select_agent,
    {
        <span class="st">"chat_agent"</span>:    <span class="st">"chat_agent"</span>,
        <span class="st">"meeting_agent"</span>: <span class="st">"meeting_agent"</span>,
    }
)

workflow.<span class="fn">add_edge</span>(<span class="st">"chat_agent"</span>,    END)
workflow.<span class="fn">add_edge</span>(<span class="st">"meeting_agent"</span>, END)

app = workflow.<span class="fn">compile</span>(checkpointer=checkpointer)</div>
    </div>

  </div>

  <!-- Info Cards -->
  <div class="info-grid">
    <div class="info-card c1">
      <div class="card-icon">âš¡</div>
      <div class="card-title">TOKEN ROUTER EDGE</div>
      <div class="card-desc">STARTì—ì„œ ì¡°ê±´ë¶€ ë¶„ê¸°. í† í° ë¯¸ì´ˆê³¼ ì‹œ summarize ë…¸ë“œ ì™„ì „ ìŠ¤í‚µ â€” ë¶ˆí•„ìš”í•œ ì‹¤í–‰ ì—†ìŒ</div>
    </div>
    <div class="info-card c2">
      <div class="card-icon">ğŸ“</div>
      <div class="card-title">MESSAGES ì§ì ‘ êµì²´</div>
      <div class="card-desc">LangMem ì œê±°. RemoveMessage + SystemMessage(ìš”ì•½)ë¥¼ í•œ ë…¸ë“œì—ì„œ ë°˜í™˜. summarized_messages í‚¤ ë¶ˆí•„ìš”</div>
    </div>
    <div class="info-card c3">
      <div class="card-icon">ğŸ¤–</div>
      <div class="card-title">DETECT AGENT</div>
      <div class="card-desc">gpt-4o-minië¡œ ì¸í…íŠ¸ ê°ì§€. agent_type ëª…ì‹œ ì‹œ LLM í˜¸ì¶œ ìŠ¤í‚µ â€” chat / meeting ë¶„ê¸°</div>
    </div>
    <div class="info-card c4">
      <div class="card-icon">ğŸ™ï¸</div>
      <div class="card-title">MEETING SUB-AGENT</div>
      <div class="card-desc">RouterState ê¸°ë°˜ ì„œë¸Œê·¸ë˜í”„. audio_file_path â†’ WhisperX STT â†’ merge â†’ gpt-4o íšŒì˜ë¡</div>
    </div>
  </div>

  <div class="footer">
    <span><span class="status-dot"></span>SYSTEM NOMINAL</span>
    <span>v4.0 Â· token_router edge Â· tiktoken ë¡œì»¬ ê³„ì‚° Â· messages ì§ì ‘ êµì²´ Â· chat + meeting sub-agent</span>
    <span>THRESHOLD 70%</span>
  </div>

</div>

<script>
  function showTab(id, el) {
    document.querySelectorAll('.code-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    el.classList.add('active');
  }
</script>
</body>
</html>