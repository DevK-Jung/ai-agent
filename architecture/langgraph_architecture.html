<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ai-agent LangGraph Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0d1117;
    color: #c9d1d9;
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    padding: 40px 20px 60px;
  }

  h1 {
    text-align: center;
    font-size: 1rem;
    color: #58a6ff;
    letter-spacing: 0.15em;
    margin-bottom: 4px;
  }

  .subtitle {
    text-align: center;
    font-size: 0.68rem;
    color: #30363d;
    margin-bottom: 44px;
    letter-spacing: 0.1em;
  }

  .diagram { max-width: 860px; margin: 0 auto; }
  .center  { display: flex; justify-content: center; }

  .node {
    border-radius: 8px;
    padding: 12px 18px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .node-icon  { font-size: 1rem; margin-top: 1px; flex-shrink: 0; }
  .node-title { font-size: 0.78rem; font-weight: 700; letter-spacing: 0.03em; }
  .node-detail { font-size: 0.63rem; color: #6e7681; margin-top: 3px; line-height: 1.6; }
  .node-file  { font-size: 0.6rem; margin-top: 6px; padding: 2px 7px; border-radius: 4px; display: inline-block; background: #21262d; color: #8b949e; }

  .n-terminal { background:#161b22; border:1.5px solid #30363d; width:160px; justify-content:center; padding:10px 16px; }
  .n-terminal .node-title { color:#8b949e; font-size:0.72rem; }

  .n-router { background:#161b22; border:1.5px solid #6e40c9; width:420px; }
  .n-router .node-title { color:#d2a8ff; }

  .n-action { background:#161b22; border:1.5px solid #238636; width:420px; }
  .n-action .node-title { color:#3fb950; }

  .n-llm { background:#161b22; border:1.5px solid #d29922; width:420px; }
  .n-llm .node-title { color:#e3b341; }

  .n-summary { background:#161b22; border:1.5px solid #da3633; width:420px; }
  .n-summary .node-title { color:#f85149; }

  .arrow { display:flex; flex-direction:column; align-items:center; margin:2px 0; }
  .arrow-shaft { width:1px; min-height:22px; background:#30363d; }
  .arrow-tip { width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:7px solid #30363d; }

  .fork { display:flex; justify-content:center; gap:20px; position:relative; padding-top:6px; }
  .fork::before { content:''; position:absolute; top:0; left:calc(50% - 120px); right:calc(50% - 120px); height:1px; background:#30363d; }

  .branch { display:flex; flex-direction:column; align-items:center; }

  .branch-tag { font-size:0.6rem; padding:2px 9px; border-radius:20px; margin-bottom:6px; letter-spacing:0.05em; }
  .tag-false { background:#1f2d3d; color:#58a6ff; border:1px solid #1f6feb; }
  .tag-true  { background:#1b2a1b; color:#3fb950; border:1px solid #238636; }
  .tag-over  { background:#2d1c1c; color:#f85149; border:1px solid #da3633; }
  .tag-under { background:#2a2210; color:#e3b341; border:1px solid #d29922; }

  .merge-label { font-size:0.6rem; color:#30363d; text-align:center; margin:2px 0; letter-spacing:0.05em; }

  .legend {
    max-width: 860px; margin: 40px auto 0;
    display: grid; grid-template-columns: repeat(3,1fr); gap: 12px;
  }

  .leg { background:#161b22; border:1px solid #21262d; border-radius:8px; padding:14px 16px; }
  .leg-title { font-size:0.7rem; font-weight:700; margin-bottom:8px; }
  .leg-body  { font-size:0.62rem; color:#6e7681; line-height:1.8; }
  .leg-body code { color:#8b949e; background:#21262d; padding:1px 5px; border-radius:3px; }

  .filetree { max-width:860px; margin:24px auto 0; background:#161b22; border:1px solid #21262d; border-radius:8px; padding:20px 24px; }
  .filetree-title { font-size:0.68rem; color:#58a6ff; margin-bottom:14px; letter-spacing:0.1em; }
  .filetree pre { font-size:0.68rem; line-height:2; color:#30363d; }
  .ft-router  { color:#d2a8ff; }
  .ft-node    { color:#3fb950; }
  .ft-wf      { color:#e3b341; }
  .ft-state   { color:#58a6ff; }
  .ft-model   { color:#f85149; }
</style>
</head>
<body>

<h1>ai-agent Â· Chat Workflow Architecture</h1>
<p class="subtitle">// app/agents/ â€” checkpointer memory + summarization</p>

<div class="diagram">

  <div class="center">
    <div class="node n-terminal"><div class="node-title">â–¶ START</div></div>
  </div>

  <div class="center"><div class="arrow"><div class="arrow-shaft"></div><div class="arrow-tip"></div></div></div>

  <!-- ROUTER 1 -->
  <div class="center">
    <div class="node n-router">
      <div class="node-icon">â¬¡</div>
      <div>
        <div class="node-title">need_prev_conversation</div>
        <div class="node-detail">checkpointer.aget(config) í˜¸ì¶œ â†’ thread_id ê¸°ì¤€ ì´ì „ State ì¡´ì¬ ì—¬ë¶€ í™•ì¸</div>
        <div class="node-file">routers/conversation_router.py</div>
      </div>
    </div>
  </div>

  <!-- ë¶„ê¸° 1 -->
  <div class="fork">
    <div class="branch">
      <div class="branch-tag tag-true">ì—†ìŒ â†’ DB ì¡°íšŒ í•„ìš”</div>
      <div class="arrow"><div class="arrow-shaft" style="min-height:14px"></div><div class="arrow-tip"></div></div>
      <div class="node n-action" style="width:360px;">
        <div class="node-icon">ğŸ—„</div>
        <div>
          <div class="node-title">load_history_from_db</div>
          <div class="node-detail">
            conversation_messages í…Œì´ë¸” ì¡°íšŒ (session_id ê¸°ì¤€)<br>
            ìµœê·¼ 20ê°œ â†’ LLM ìš”ì•½ â†’ SystemMessageë¡œ ì£¼ì…
          </div>
          <div class="node-file">nodes/load_history_from_db.py</div>
        </div>
      </div>
    </div>
    <div class="branch">
      <div class="branch-tag tag-false">ìˆìŒ â†’ State ìë™ ë³µì›</div>
      <div style="height:18px; display:flex; align-items:center;">
        <span style="font-size:0.6rem; color:#30363d;">checkpointer ìë™ ì²˜ë¦¬ (skip)</span>
      </div>
      <div style="height:56px;"></div>
    </div>
  </div>

  <div class="center"><div class="arrow"><div class="arrow-shaft"></div><div class="arrow-tip"></div></div></div>
  <div class="merge-label">â†‘ í•©ë¥˜</div>

  <!-- ROUTER 2 -->
  <div class="center">
    <div class="node n-router">
      <div class="node-icon">â¬¡</div>
      <div>
        <div class="node-title">check_token_count</div>
        <div class="node-detail">count_tokens_approximately(state["messages"]) > 8000 ì—¬ë¶€ íŒë‹¨</div>
        <div class="node-file">routers/token_router.py</div>
      </div>
    </div>
  </div>

  <!-- ë¶„ê¸° 2 -->
  <div class="fork">
    <div class="branch">
      <div class="branch-tag tag-over">ì´ˆê³¼ â†’ ìš”ì•½ í•„ìš”</div>
      <div class="arrow"><div class="arrow-shaft" style="min-height:14px"></div><div class="arrow-tip"></div></div>
      <div class="node n-summary" style="width:360px;">
        <div class="node-icon">âˆ‘</div>
        <div>
          <div class="node-title">summarize_conversation</div>
          <div class="node-detail">
            ê¸°ì¡´ summary ìˆìœ¼ë©´ ëˆ„ì  í™•ì¥, ì—†ìœ¼ë©´ ì‹ ê·œ ìƒì„±<br>
            RemoveMessage â†’ ìµœê·¼ 2ê°œë§Œ ìœ ì§€<br>
            state["summary"] ì—…ë°ì´íŠ¸
          </div>
          <div class="node-file">nodes/summarize_conversation.py</div>
        </div>
      </div>
    </div>
    <div class="branch">
      <div class="branch-tag tag-under">ì´í•˜ â†’ ê·¸ëŒ€ë¡œ ì§„í–‰</div>
      <div style="height:18px; display:flex; align-items:center;">
        <span style="font-size:0.6rem; color:#30363d;">pass-through</span>
      </div>
      <div style="height:76px;"></div>
    </div>
  </div>

  <div class="center"><div class="arrow"><div class="arrow-shaft"></div><div class="arrow-tip"></div></div></div>
  <div class="merge-label">â†‘ í•©ë¥˜</div>

  <!-- LLM ë…¸ë“œ -->
  <div class="center">
    <div class="node n-llm">
      <div class="node-icon">âš¡</div>
      <div>
        <div class="node-title">ê¸°ì¡´ classifier â†’ generator ë…¸ë“œ</div>
        <div class="node-detail">
          summary ìˆìœ¼ë©´ SystemMessageë¡œ prepend í›„ LLM í˜¸ì¶œ<br>
          FACT / SUMMARY / COMPARE / EVIDENCE ë¶„ë¥˜ â†’ ë‹µë³€ ìƒì„± (SSE)
        </div>
        <div class="node-file">nodes/ (ê¸°ì¡´ ìœ ì§€, summary ì£¼ì… ë¡œì§ë§Œ ì¶”ê°€)</div>
      </div>
    </div>
  </div>

  <div class="center"><div class="arrow"><div class="arrow-shaft"></div><div class="arrow-tip"></div></div></div>

  <!-- DB ì €ì¥ -->
  <div class="center">
    <div class="node n-action">
      <div class="node-icon">ğŸ’¾</div>
      <div>
        <div class="node-title">save_message_to_db</div>
        <div class="node-detail">
          human + ai ë©”ì‹œì§€ â†’ conversation_messages í…Œì´ë¸” INSERT<br>
          ì²´í¬í¬ì¸í„° TTL ë§Œë£Œ í›„ ë³µì› + UI ì´ë ¥ í‘œì‹œìš© ì˜êµ¬ ë³´ì¡´
        </div>
        <div class="node-file">nodes/save_message_to_db.py</div>
      </div>
    </div>
  </div>

  <div class="center"><div class="arrow"><div class="arrow-shaft"></div><div class="arrow-tip"></div></div></div>

  <div class="center">
    <div class="node n-terminal"><div class="node-title">â–  END</div></div>
  </div>

</div>

<!-- ë²”ë¡€ -->
<div class="legend">
  <div class="leg">
    <div class="leg-title" style="color:#d2a8ff;">â¬¡ need_prev_conversation</div>
    <div class="leg-body">
      <code>checkpointer.aget(config)</code> í˜¸ì¶œ<br>
      ìˆìŒ â†’ token checkë¡œ ë°”ë¡œ<br>
      ì—†ìŒ â†’ <code>load_history_from_db</code> ê²½ìœ <br><br>
      ë°˜í™˜: <code>"load_db" | "check_token"</code>
    </div>
  </div>

  <div class="leg">
    <div class="leg-title" style="color:#3fb950;">ğŸ—„ load_history_from_db</div>
    <div class="leg-body">
      ê¸°ì¡´ <code>ChatRequest.session_id</code> í™œìš©<br>
      <code>conversation_messages</code> í…Œì´ë¸” ì¡°íšŒ<br>
      ìµœê·¼ 20ê°œ â†’ LLM ìš”ì•½ â†’ <code>SystemMessage</code> ì£¼ì…<br><br>
      ì‹ ê·œ í…Œì´ë¸” <code>conversation_messages</code> í•„ìš”
    </div>
  </div>

  <div class="leg">
    <div class="leg-title" style="color:#d2a8ff;">â¬¡ check_token_count</div>
    <div class="leg-body">
      <code>count_tokens_approximately</code> ì‚¬ìš©<br>
      8000 ì´ˆê³¼ â†’ <code>summarize_conversation</code><br>
      ì´í•˜ â†’ <code>classifier</code> ë¡œ ë°”ë¡œ<br><br>
      ë°˜í™˜: <code>"summarize" | "classify"</code>
    </div>
  </div>

  <div class="leg">
    <div class="leg-title" style="color:#f85149;">âˆ‘ summarize_conversation</div>
    <div class="leg-body">
      <code>state["summary"]</code> ëˆ„ì  í™•ì¥ ë°©ì‹<br>
      <code>RemoveMessage</code> ë¡œ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±°<br>
      ìµœê·¼ 2ê°œ ë©”ì‹œì§€ë§Œ State ìœ ì§€<br><br>
      <code>AgentState</code>ì— <code>summary: str</code> ì¶”ê°€ í•„ìš”
    </div>
  </div>

  <div class="leg">
    <div class="leg-title" style="color:#e3b341;">âš¡ classifier â†’ generator</div>
    <div class="leg-body">
      ê¸°ì¡´ ë…¸ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€<br>
      <code>state["summary"]</code> ìˆì„ ë•Œë§Œ<br>
      <code>SystemMessage</code> prepend ë¡œì§ ì¶”ê°€<br><br>
      SSE ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€
    </div>
  </div>

  <div class="leg">
    <div class="leg-title" style="color:#3fb950;">ğŸ’¾ save_message_to_db</div>
    <div class="leg-body">
      ë§¤ í„´ë§ˆë‹¤ ì‹¤í–‰ (í•­ìƒ)<br>
      human + ai ë©”ì‹œì§€ ëª¨ë‘ ì €ì¥<br>
      ì²´í¬í¬ì¸í„°ì™€ ì™„ì „íˆ ë…ë¦½ì <br><br>
      ê¸°ì¡´ <code>document.py</code> ì˜†ì— <code>conversation.py</code> ì¶”ê°€
    </div>
  </div>
</div>

<!-- íŒŒì¼íŠ¸ë¦¬ -->
<div class="filetree">
  <div class="filetree-title">// ë³€ê²½/ì¶”ê°€ë˜ëŠ” íŒŒì¼ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)</div>
  <pre>
app/
â”œâ”€â”€ <span class="ft-model">models/</span>
â”‚   â””â”€â”€ conversation.py              # ì‹ ê·œ: ConversationMessage ORM ëª¨ë¸
â”‚
â”œâ”€â”€ <span class="ft-state">agents/</span>
â”‚   â”œâ”€â”€ state.py                     # ìˆ˜ì •: summary: str í•„ë“œ ì¶”ê°€
â”‚   â”‚
â”‚   â”œâ”€â”€ <span class="ft-router">routers/</span>                     # ì‹ ê·œ ë””ë ‰í† ë¦¬
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ conversation_router.py   # need_prev_conversation
â”‚   â”‚   â””â”€â”€ token_router.py          # check_token_count
â”‚   â”‚
â”‚   â”œâ”€â”€ <span class="ft-node">nodes/</span>                       # ê¸°ì¡´ ìœ ì§€ + ì‹ ê·œ ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ (classifier, generator)  # ê¸°ì¡´ ê·¸ëŒ€ë¡œ + summary ì£¼ì…ë§Œ ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ load_history_from_db.py  # ì‹ ê·œ
â”‚   â”‚   â”œâ”€â”€ summarize_conversation.py # ì‹ ê·œ
â”‚   â”‚   â””â”€â”€ save_message_to_db.py    # ì‹ ê·œ
â”‚   â”‚
â”‚   â””â”€â”€ <span class="ft-wf">workflows/</span>
â”‚       â””â”€â”€ chat_workflow.py         # ìˆ˜ì •: ì‹ ê·œ ë…¸ë“œ + ë¼ìš°í„° ì—°ê²°
  </pre>
</div>

</body>
</html>
